<UserControl x:Class="WebBrowserMinimalist.Views.Controls.TabItem"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:WebBrowserMinimalist.Views.Controls"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:context="clr-namespace:WebBrowserMinimalist.ViewModels"
             xmlns:helpers="clr-namespace:WebBrowserMinimalist.Helpers"
             xmlns:web="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="484" >
    <UserControl.DataContext>
        <context:TabItemVM ></context:TabItemVM>
    </UserControl.DataContext>
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="convertToVisibility"></BooleanToVisibilityConverter>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <Border x:Name="toolBar" VerticalAlignment="Stretch" Height="38" BorderThickness="0,0,0,1" >
            <Grid ClipToBounds="True">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="auto"></ColumnDefinition>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="140"/>
                </Grid.ColumnDefinitions>
                <Rectangle Fill="{Binding Foreground,ElementName=symbol}" Height="1" VerticalAlignment="Bottom" Opacity="0.2" HorizontalAlignment="Stretch" Grid.ColumnSpan="10" RadiusX="1" RadiusY="1"></Rectangle>
                
                <StackPanel Orientation="Horizontal" Margin="4">
                    <ui:Button  WindowChrome.IsHitTestVisibleInChrome="True" Appearance="Transparent" Command="{Binding BackCommand}" CommandParameter="{Binding ElementName=webview}" Visibility="{Binding CanGoBack,ElementName=webview,Converter={StaticResource convertToVisibility}}" BorderThickness="0" BorderBrush="Transparent" VerticalAlignment="Stretch" >
                        <ui:SymbolIcon Symbol="ArrowLeft12"></ui:SymbolIcon>
                    </ui:Button>
                    <Grid Width="36">
                        <ui:Button Name="btnRefresh" Visibility="Visible" WindowChrome.IsHitTestVisibleInChrome="True" Appearance="Transparent" Command="{Binding RefreshCommand}" CommandParameter="{Binding ElementName=webview}" BorderThickness="0" BorderBrush="Transparent" VerticalAlignment="Stretch">
                            <ui:SymbolIcon Symbol="ArrowReset24" Filled="True"></ui:SymbolIcon>
                        </ui:Button>
                        <ui:Button Name="btnStop" Visibility="Collapsed" WindowChrome.IsHitTestVisibleInChrome="True" Appearance="Transparent" Command="{Binding StopCommand}" CommandParameter="{Binding ElementName=webview}" BorderThickness="0" BorderBrush="Transparent" VerticalAlignment="Stretch">
                            <ui:SymbolIcon Symbol="Square12" Filled="True"></ui:SymbolIcon>
                        </ui:Button>
                    </Grid>
                    <ui:Button  WindowChrome.IsHitTestVisibleInChrome="True" Appearance="Transparent" BorderThickness="0" Command="{Binding LeftCommand}" CommandParameter="{Binding ElementName=webview}" Visibility="{Binding  CanGoForward,ElementName=webview,Converter={StaticResource convertToVisibility}}" BorderBrush="Transparent" VerticalAlignment="Stretch" >
                        <ui:SymbolIcon Symbol="ArrowRight12"></ui:SymbolIcon>
                    </ui:Button>
                </StackPanel>
                <Rectangle Fill="{Binding Foreground,ElementName=symbol}" Width="1" HorizontalAlignment="Right" RadiusX="1" RadiusY="1" Margin="0,15,0,15"></Rectangle>
                <Grid Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Center"  Margin="0,0,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="auto"></ColumnDefinition>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid Name="URLSearchBar" MaxWidth="400" Margin="10,0,26,0" Visibility="Collapsed" Grid.Column="1" >

                        <ui:Badge BorderThickness="0" HorizontalAlignment="Center" Background="Transparent" MaxWidth="400" Padding="0" Width="{Binding ActualWidth,ElementName=URLSearchBar}" Height="28" HorizontalContentAlignment="Center" >

                            <Grid>
                                <Rectangle Grid.ColumnSpan="10" Fill="{Binding Foreground,ElementName=symbol}" Opacity="0.2" RadiusX="3.563" RadiusY="3.563"></Rectangle>

                                <ui:TextBox TextChanged="TxtSearch_TextChanged" Foreground="{Binding Foreground,ElementName=symbol}" 
                                            CaretBrush="{Binding Foreground,ElementName=symbol}" FontFamily="Segoe UI" FontSize="14" 
                                            ClipToBounds="True" 
                                            Icon="Empty" Name="TxtSearch"  Text="{Binding UrlSource}" 
                                            MouseDoubleClick="TxtSearch_MouseDoubleClick" KeyDown="txtSearch_KeyDown" 
                                            VerticalAlignment="Stretch" ClearButtonEnabled="False" 
                                            WindowChrome.IsHitTestVisibleInChrome="True"  BorderThickness="0" 
                                            Background="Transparent"  PlaceholderText="url or Search" 
                                            TextAlignment="Center" VerticalContentAlignment="Center" 
                                            Padding="30,0,30,0" BorderBrush="{x:Null}"
                                            />
                                <Popup Name="flyResults"
                                          AllowsTransparency="true" 
                                          Placement="Bottom"  
                                          StaysOpen="False"
                                          PopupAnimation="Fade" VerticalOffset="10" Width="{Binding ActualWidth,ElementName=URLSearchBar}">
                                    <Border Padding="0"  Background="{ui:ThemeResource}" CornerRadius="10" BorderThickness="1" >
                                        <Border.BorderBrush>
                                            <SolidColorBrush Color="Black" Opacity="0.3"/>
                                        </Border.BorderBrush>
                                        <ListView Name="listResultSearch" ItemsSource="{Binding ResultItems,Mode=OneWay}" SelectionMode="Single">
                                            <ListView.ItemTemplate>
                                                <DataTemplate>
                                                    <ui:Button Name="btnItemResultSearch" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" Click="btnItemResultSearch_Click">
                                                        <Grid Margin="0">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="auto"></ColumnDefinition>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <ui:SymbolIcon Symbol="History16" FontSize="20" Margin="0,0,7,0"></ui:SymbolIcon>
                                                            <StackPanel Grid.Column="1" >
                                                                <TextBlock Text="{Binding TitleDocument}" TextTrimming="CharacterEllipsis"></TextBlock>
                                                                <TextBlock Text="{Binding URL}" Opacity="0.5" TextTrimming="CharacterEllipsis"></TextBlock>
                                                            </StackPanel>
                                                        </Grid>
                                                    </ui:Button>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                        </ListView>
                                    </Border>
                                </Popup>

                                <ui:Button Name="ReturnToIndicator" ToolTip="Cerrar Barra de Busqueda"
                                           Click="ReturnToIndicator_Click" HorizontalContentAlignment="Center" Padding="5" WindowChrome.IsHitTestVisibleInChrome="True" Appearance="Transparent" BorderThickness="0" BorderBrush="Transparent" VerticalAlignment="Stretch" >
                                    <ui:SymbolIcon Symbol="ArrowRight12" Filled="True" FontSize="16"></ui:SymbolIcon>
                                </ui:Button>
                                <ui:Button Name="btnSettingEngines" ToolTip="Configuracion de Motor de Busqueda" HorizontalAlignment="Right" Click="btnSettingEngines_Click" WindowChrome.IsHitTestVisibleInChrome="True" Padding="5" Appearance="Transparent" BorderThickness="0" BorderBrush="Transparent" VerticalAlignment="Stretch" >
                                    <Grid>
                                        <ui:SymbolIcon Symbol="Settings20" FontSize="16"></ui:SymbolIcon>
                                        <Popup Name="FlyoutSettingPanel"
                                          AllowsTransparency="true" 
                                          Placement="Bottom"  
                                          StaysOpen="False"
                                          PopupAnimation="Fade" HorizontalOffset="-80" VerticalOffset="15">
                                            <Border Margin="0" Padding="0" Background="{ui:ThemeResource}" CornerRadius="10" BorderThickness="1" >
                                                <Border.BorderBrush>
                                                    <SolidColorBrush Color="{Binding Foreground,ElementName=symbol}" Opacity="0.2"></SolidColorBrush>
                                                </Border.BorderBrush>
                                                <local:SettingsControls ></local:SettingsControls>
                                            </Border>
                                        </Popup>
                                    </Grid>
                                </ui:Button>
                               
                            </Grid>
                        </ui:Badge>

                    </Grid>
                    <ui:Badge x:Name="IndicatorDocumentPage" Margin="5,0,26,0"  Background="Transparent" Grid.Column="1" MaxWidth="400" Padding="0" Height="28" >
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="auto"/>
                            </Grid.ColumnDefinitions>
                            <Rectangle Grid.ColumnSpan="10" Fill="{Binding Foreground,ElementName=symbol}" Opacity="0.2" RadiusX="3.563" RadiusY="3.563"></Rectangle>
                            <StackPanel Orientation="Horizontal" Margin="4,0,0,0">
                                <ui:SymbolIcon Name="symbol" Symbol="{Binding ShieldIcon}" Margin="4,0,6,0" Filled="True" FontSize="18"></ui:SymbolIcon>
                                <ui:SymbolIcon Visibility="{Binding SoundVisibility,Mode=OneWay}" Symbol="Speaker224" Margin="2,0,6,0" FontSize="16"></ui:SymbolIcon>
                            </StackPanel>
                            <ui:Button  Name="btnChangeToSearch" Click="btnChangeToSearch_Click" Padding="5" Grid.Column="3" Margin="0,0,0,0" WindowChrome.IsHitTestVisibleInChrome="True" Appearance="Transparent" BorderThickness="0" BorderBrush="Transparent" VerticalAlignment="Stretch" >
                                <ui:SymbolIcon Symbol="Search12" Filled="True" FontSize="12"></ui:SymbolIcon>
                            </ui:Button>
                            <Grid HorizontalAlignment="Center" Grid.Column="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="auto"></ColumnDefinition>
                                    <ColumnDefinition Width="auto"></ColumnDefinition>
                                    <ColumnDefinition Width="*"></ColumnDefinition>
                                    <ColumnDefinition Width="auto"></ColumnDefinition>
                                </Grid.ColumnDefinitions>
                                <ui:ProgressRing Name="progressring" Grid.Column="1" IsIndeterminate="True" Progress="0" Visibility="{Binding ProgressVisibility}" Height="16" Width="16"></ui:ProgressRing>

                                <Image Name="img" Source="{Binding Image}" Grid.Column="1" Height="16" Width="16" Stretch="None"></Image>
                                <TextBlock VerticalAlignment="Center" WindowChrome.IsHitTestVisibleInChrome="True" ToolTip="{Binding TitleDocument}" FontSize="13" Grid.Column="2" Foreground="{Binding Foreground, ElementName=symbol}" HorizontalAlignment="Stretch" Opacity="1" FontStretch="ExtraExpanded" Text="{Binding TitleDocument}" Margin="7,0,0,0" Padding="0" TextTrimming="CharacterEllipsis" FontFamily="Segoe UI Semibold" />


                            </Grid>
                        </Grid>
                    </ui:Badge>
                    
                    <StackPanel Orientation="Horizontal" Margin="4,0,0,0">
                        <ui:Button Name="menubtn" Click="menubtn_Click" Height="{Binding ActualHeight,ElementName=btnRefresh}" Grid.Column="0" Margin="0,0,0,0" WindowChrome.IsHitTestVisibleInChrome="True" Appearance="Transparent" BorderThickness="0" BorderBrush="Transparent" VerticalAlignment="Stretch" >
                            <ui:SymbolIcon Name="tabssymbol" Symbol="Tabs20" Filled="False"></ui:SymbolIcon>
                        </ui:Button>
                        <Button  Name="countitem" Visibility="Visible" Margin="4,0,0,0" Height="22" Padding="7,0" FontSize="12" VerticalAlignment="Stretch" Content="{Binding Items.Count, Mode=OneWay}" >
                        </Button>
                    </StackPanel>
                </Grid>
            </Grid>
        
        </Border>


        <Grid Name="navegador" Grid.Row="1">
            <web:WebView2 Name="webview"  Source="{Binding Url}" DefaultBackgroundColor="transparent" >
                <web:WebView2.CreationProperties>
                    <web:CoreWebView2CreationProperties IsInPrivateModeEnabled="True"></web:CoreWebView2CreationProperties>
                </web:WebView2.CreationProperties>
            </web:WebView2>
        </Grid>
    </Grid>
</UserControl>
